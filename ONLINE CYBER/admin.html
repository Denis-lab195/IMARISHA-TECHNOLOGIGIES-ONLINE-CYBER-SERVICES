<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imarisha Technologies | Admin Dashboard</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --kenya-black: #000000;
            --kenya-red: #BB0000;
            --kenya-green: #006600;
            --kenya-white: #FFFFFF;
            --kenya-yellow: #FCD116;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background-color: #f0f2f5;
            min-height: 100vh;
        }

        /* Login Page */
        .login-page {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--kenya-black) 0%, var(--kenya-green) 100%);
        }

        .login-container {
            width: 100%;
            max-width: 500px;
            margin: auto;
            background-color: var(--kenya-white);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo-icon {
            background-color: var(--kenya-red);
            color: var(--kenya-white);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 20px;
        }

        .login-logo h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            color: var(--kenya-black);
            margin-bottom: 10px;
        }

        .login-logo p {
            color: var(--kenya-green);
            font-size: 1rem;
        }

        .login-form .form-group {
            margin-bottom: 25px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--kenya-black);
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--kenya-green);
            box-shadow: 0 0 0 3px rgba(0,102,0,0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--kenya-green);
            color: var(--kenya-white);
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background-color: var(--kenya-black);
        }

        .login-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Dashboard Container */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--kenya-black) 0%, var(--kenya-green) 100%);
            color: var(--kenya-white);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background-color: var(--kenya-red);
            color: var(--kenya-white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .logo-text h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            color: var(--kenya-white);
        }

        .logo-text p {
            font-size: 0.9rem;
            color: var(--kenya-yellow);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--kenya-yellow);
            color: var(--kenya-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .user-details h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .user-details p {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }

        .logout-btn {
            background-color: var(--kenya-red);
            color: var(--kenya-white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background-color: #990000;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background-color: var(--kenya-white);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-top: 4px solid var(--kenya-green);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--kenya-white);
            background-color: var(--kenya-green);
        }

        .stat-title {
            font-size: 1rem;
            color: var(--dark-gray);
            font-weight: 500;
        }

        .stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            color: var(--kenya-black);
            margin-bottom: 10px;
        }

        /* Service Requests Section */
        .requests-section {
            background-color: var(--kenya-white);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            color: var(--kenya-black);
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            background-color: var(--kenya-white);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 300px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        /* Status Tabs */
        .status-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 25px;
        }

        .status-tab {
            padding: 15px 30px;
            background: none;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--dark-gray);
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .status-tab:hover {
            color: var(--kenya-green);
        }

        .status-tab.active {
            color: var(--kenya-green);
        }

        .status-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--kenya-green);
        }

        .status-tab .badge {
            background-color: var(--kenya-red);
            color: var(--kenya-white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* Requests Table */
        .requests-table {
            width: 100%;
            border-collapse: collapse;
        }

        .requests-table th {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--kenya-black);
            border-bottom: 2px solid #eee;
        }

        .requests-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .requests-table tr:hover {
            background-color: #f9f9f9;
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--kenya-green);
            color: var(--kenya-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .service-details h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .service-details p {
            font-size: 0.85rem;
            color: #666;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .urgency-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .urgency-normal {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .urgency-high {
            background-color: #ffecb3;
            color: #ff8f00;
        }

        .urgency-urgent {
            background-color: #ffcdd2;
            color: #c62828;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            border: none;
            background-color: #f0f0f0;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background-color: var(--kenya-green);
            color: var(--kenya-white);
        }

        .action-btn.view:hover {
            background-color: var(--kenya-green);
        }

        .action-btn.update:hover {
            background-color: #0081C8;
        }

        .action-btn.delete:hover {
            background-color: var(--kenya-red);
        }

        /* Request Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--kenya-white);
            width: 90%;
            max-width: 800px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--kenya-black) 0%, var(--kenya-green) 100%);
            color: var(--kenya-white);
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--kenya-white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 30px;
        }

        .request-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-group {
            margin-bottom: 20px;
        }

        .detail-group label {
            display: block;
            font-weight: 500;
            color: var(--dark-gray);
            margin-bottom: 8px;
        }

        .detail-value {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .detail-value p {
            margin: 0;
            line-height: 1.5;
        }

        /* Update Status Modal */
        .status-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--kenya-black);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--kenya-green);
            box-shadow: 0 0 0 3px rgba(0,102,0,0.1);
        }

        .save-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--kenya-green);
            color: var(--kenya-white);
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-btn:hover {
            background-color: var(--kenya-black);
        }

        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-data i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .no-data p {
            font-size: 1.1rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: var(--kenya-green);
        }

        .toast.error {
            background-color: var(--kenya-red);
        }

        .toast.info {
            background-color: #0081C8;
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loader.active {
            display: flex;
        }

        .loader-content {
            background-color: var(--kenya-white);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--kenya-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-box input {
                width: 200px;
            }
            
            .request-details-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .filter-controls {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .search-box {
                flex: 1;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .status-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .requests-table {
                display: block;
                overflow-x: auto;
            }
            
            .login-container {
                padding: 30px;
                margin: 20px;
            }
        }

        @media (max-width: 576px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-icon">
                    <i class="fas fa-desktop"></i>
                </div>
                <h1>IMARISHA TECH</h1>
                <p>Admin Dashboard Login</p>
            </div>
            
            <div class="login-error" id="loginError">
                Invalid email or password. Please try again.
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" placeholder="admin@imarisha.co.ke" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login to Dashboard
                </button>
            </form>
            
            <div class="login-footer">
                <p>Only authorized administrators can access this dashboard</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <header>
            <div class="header-container">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div class="logo-text">
                        <h1>IMARISHA TECHNOLOGIES</h1>
                        <p>Service Requests Admin Dashboard</p>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h3 id="userName">Admin User</h3>
                        <p id="userRole">Administrator</p>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-title">Total Requests</div>
                    </div>
                    <div class="stat-value" id="totalRequests">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: var(--kenya-red);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-title">Pending Requests</div>
                    </div>
                    <div class="stat-value" id="pendingRequests">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: #0081C8;">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="stat-title">In Progress</div>
                    </div>
                    <div class="stat-value" id="processingRequests">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background-color: var(--kenya-green);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-title">Completed</div>
                    </div>
                    <div class="stat-value" id="completedRequests">0</div>
                </div>
            </div>

            <!-- Service Requests Section -->
            <div class="requests-section">
                <div class="section-header">
                    <h2>Service Requests</h2>
                    <div class="filter-controls">
                        <select class="filter-select" id="filterService">
                            <option value="all">All Services</option>
                            <!-- Services will be populated from Firebase -->
                        </select>
                        
                        <select class="filter-select" id="filterUrgency">
                            <option value="all">All Urgency</option>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                        
                        <select class="filter-select" id="filterDate">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                        
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Search requests...">
                        </div>
                    </div>
                </div>
                
                <!-- Status Tabs -->
                <div class="status-tabs">
                    <button class="status-tab active" data-status="all">
                        All Requests <span class="badge" id="badgeAll">0</span>
                    </button>
                    <button class="status-tab" data-status="pending">
                        Pending <span class="badge" id="badgePending">0</span>
                    </button>
                    <button class="status-tab" data-status="processing">
                        In Progress <span class="badge" id="badgeProcessing">0</span>
                    </button>
                    <button class="status-tab" data-status="completed">
                        Completed <span class="badge" id="badgeCompleted">0</span>
                    </button>
                    <button class="status-tab" data-status="cancelled">
                        Cancelled <span class="badge" id="badgeCancelled">0</span>
                    </button>
                </div>
                
                <!-- Requests Table -->
                <div class="table-container">
                    <table class="requests-table">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Cost</th>
                                <th>Urgency</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="6" class="no-data">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading service requests from Firebase...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal" id="requestDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Service Request Details</h3>
                <button class="close-modal" id="closeDetailsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="requestDetailsContent">
                    <!-- Request details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal" id="updateStatusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Request Status</h3>
                <button class="close-modal" id="closeUpdateModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="updateStatusContent">
                    <!-- Update form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h3>Loading...</h3>
            <p>Please wait while we fetch your data</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
    apiKey: "AIzaSyAL4V8WmSQis5WILYaoHOZ8sY4b7XoC7u4",
    authDomain: "farm-iq-a74bb.firebaseapp.com",
    projectId: "farm-iq-a74bb",
    storageBucket: "farm-iq-a74bb.firebasestorage.app",
    messagingSenderId: "282490627955",
    appId: "1:282490627955:web:d94f6a5946256b13cbc706",
    measurementId: "G-CMBF5XFMCC"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let allRequests = [];
        let filteredRequests = [];
        let requestsListener = null;
        let currentRequestId = null;

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const searchInput = document.getElementById('searchInput');
        const requestsTableBody = document.getElementById('requestsTableBody');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // First, check Firebase connection
            checkFirebaseConnection();
            
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showDashboard();
                    setupRealtimeListeners();
                } else {
                    showLogin();
                }
            });

            // Setup event listeners
            setupEventListeners();
        });

        // Check Firebase connection
        function checkFirebaseConnection() {
            db.collection('serviceRequests').limit(1).get()
                .then(() => {
                    console.log('Firebase connection successful');
                    showToast('Connected to Firebase successfully', 'success');
                })
                .catch((error) => {
                    console.error('Firebase connection failed:', error);
                    showToast('Firebase connection failed. Please check your configuration.', 'error');
                });
        }

        // Show login page
        function showLogin() {
            loginPage.style.display = 'flex';
            dashboardContainer.style.display = 'none';
            loginForm.reset();
            loginError.classList.remove('show');
        }

        // Show dashboard
        function showDashboard() {
            loginPage.style.display = 'none';
            dashboardContainer.style.display = 'block';
            
            // Update user info
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                userName.textContent = displayName;
                const initials = getInitials(displayName);
                userAvatar.textContent = initials;
            }
        }

        // Setup realtime listener for serviceRequests
        function setupRealtimeListeners() {
            showLoader();
            
            // Listen for serviceRequests from YOUR Firebase structure
            requestsListener = db.collection('serviceRequests')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    allRequests = [];
                    const uniqueServices = new Set();
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        allRequests.push({
                            id: doc.id,
                            ...data
                        });
                        
                        // Collect unique service names for filter dropdown
                        if (data.serviceName) {
                            uniqueServices.add(data.serviceName);
                        }
                    });
                    
                    // Update service filter dropdown
                    updateServiceFilter(Array.from(uniqueServices));
                    
                    updateDashboardStats();
                    filterAndDisplayRequests();
                    updateStatusBadges();
                    
                    hideLoader();
                    
                    if (allRequests.length > 0) {
                        showToast(`Loaded ${allRequests.length} service requests from Firebase`, 'success');
                    }
                }, (error) => {
                    console.error('Error loading service requests:', error);
                    showToast('Error loading requests from Firebase. Please check your configuration.', 'error');
                    hideLoader();
                });
        }

        // Update service filter dropdown
        function updateServiceFilter(services) {
            const filterSelect = document.getElementById('filterService');
            
            // Clear existing options except "All Services"
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            // Add services to dropdown
            services.sort().forEach(service => {
                const option = document.createElement('option');
                option.value = service;
                option.textContent = service;
                filterSelect.appendChild(option);
            });
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const totalRequests = allRequests.length;
            const pendingRequests = allRequests.filter(req => req.status === 'pending').length;
            const processingRequests = allRequests.filter(req => req.status === 'processing').length;
            const completedRequests = allRequests.filter(req => req.status === 'completed').length;
            
            // Update UI
            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('pendingRequests').textContent = pendingRequests;
            document.getElementById('processingRequests').textContent = processingRequests;
            document.getElementById('completedRequests').textContent = completedRequests;
        }

        // Update status badges
        function updateStatusBadges() {
            const allCount = allRequests.length;
            const pendingCount = allRequests.filter(req => req.status === 'pending').length;
            const processingCount = allRequests.filter(req => req.status === 'processing').length;
            const completedCount = allRequests.filter(req => req.status === 'completed').length;
            const cancelledCount = allRequests.filter(req => req.status === 'cancelled').length;
            
            document.getElementById('badgeAll').textContent = allCount;
            document.getElementById('badgePending').textContent = pendingCount;
            document.getElementById('badgeProcessing').textContent = processingCount;
            document.getElementById('badgeCompleted').textContent = completedCount;
            document.getElementById('badgeCancelled').textContent = cancelledCount;
        }

        // Filter and display requests
        function filterAndDisplayRequests() {
            const statusFilter = document.querySelector('.status-tab.active')?.getAttribute('data-status') || 'all';
            const serviceFilter = document.getElementById('filterService').value;
            const urgencyFilter = document.getElementById('filterUrgency').value;
            const dateFilter = document.getElementById('filterDate').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredRequests = allRequests.filter(request => {
                // Filter by status
                if (statusFilter !== 'all' && request.status !== statusFilter) {
                    return false;
                }
                
                // Filter by service
                if (serviceFilter !== 'all' && request.serviceName !== serviceFilter) {
                    return false;
                }
                
                // Filter by urgency
                if (urgencyFilter !== 'all' && request.urgency !== urgencyFilter) {
                    return false;
                }
                
                // Filter by date
                if (dateFilter !== 'all' && request.createdAt) {
                    try {
                        const requestDate = request.createdAt.toDate ? 
                            request.createdAt.toDate() : 
                            new Date(request.createdAt);
                        const now = new Date();
                        
                        if (dateFilter === 'today') {
                            const todayString = now.toISOString().split('T')[0];
                            const requestDateString = requestDate.toISOString().split('T')[0];
                            if (requestDateString !== todayString) return false;
                        } else if (dateFilter === 'week') {
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (requestDate < weekAgo) return false;
                        } else if (dateFilter === 'month') {
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (requestDate < monthAgo) return false;
                        }
                    } catch (e) {
                        // If date parsing fails, include the request
                    }
                }
                
                // Filter by search term
                if (searchTerm) {
                    const searchFields = [
                        request.serviceName || '',
                        request.serviceId || '',
                        request.details || '',
                        request.cost || '',
                        request.urgency || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            displayRequests();
        }

        // Display requests in table
        function displayRequests() {
            const tableBody = document.getElementById('requestsTableBody');
            
            if (filteredRequests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">
                            <i class="fas fa-inbox fa-2x"></i>
                            <p>No service requests found matching your filters</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = '';
            
            filteredRequests.forEach(request => {
                const row = document.createElement('tr');
                
                // Get status class and text
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                
                switch(request.status) {
                    case 'processing':
                        statusClass = 'status-processing';
                        statusText = 'In Progress';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'Completed';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = 'Cancelled';
                        break;
                }
                
                // Get urgency class and text
                let urgencyClass = 'urgency-normal';
                let urgencyText = 'Normal';
                
                switch(request.urgency) {
                    case 'high':
                        urgencyClass = 'urgency-high';
                        urgencyText = 'High';
                        break;
                    case 'urgent':
                        urgencyClass = 'urgency-urgent';
                        urgencyText = 'Urgent';
                        break;
                }
                
                // Format date
                let dateFormatted = 'N/A';
                try {
                    const requestDate = request.createdAt?.toDate ? 
                        request.createdAt.toDate() : 
                        new Date(request.createdAt);
                    dateFormatted = requestDate.toLocaleDateString('en-KE', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    dateFormatted = 'N/A';
                }
                
                // Get service icon
                const serviceIcon = getServiceIcon(request.serviceName);
                
                row.innerHTML = `
                    <td>
                        <div class="service-info">
                            <div class="service-icon">
                                <i class="${serviceIcon}"></i>
                            </div>
                            <div class="service-details">
                                <h4>${request.serviceName || 'Unknown Service'}</h4>
                                <p>${request.serviceId || 'No ID'}</p>
                            </div>
                        </div>
                    </td>
                    <td>${request.cost || 'KES 0'}</td>
                    <td>
                        <span class="urgency-badge ${urgencyClass}">
                            ${urgencyText}
                        </span>
                    </td>
                    <td>${dateFormatted}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" title="View Details" onclick="viewRequestDetails('${request.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn update" title="Update Status" onclick="showUpdateStatusForm('${request.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="Delete Request" onclick="deleteRequest('${request.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Get appropriate icon for service
        function getServiceIcon(serviceName) {
            if (!serviceName) return 'fas fa-question';
            
            const service = serviceName.toLowerCase();
            
            if (service.includes('work permit') || service.includes('visa')) {
                return 'fas fa-passport';
            } else if (service.includes('kra') || service.includes('tax')) {
                return 'fas fa-file-invoice-dollar';
            } else if (service.includes('ntsa') || service.includes('license')) {
                return 'fas fa-car';
            } else if (service.includes('helb') || service.includes('loan')) {
                return 'fas fa-graduation-cap';
            } else if (service.includes('tsc') || service.includes('teacher')) {
                return 'fas fa-chalkboard-teacher';
            } else if (service.includes('passport')) {
                return 'fas fa-id-card';
            } else if (service.includes('business') || service.includes('company')) {
                return 'fas fa-briefcase';
            } else {
                return 'fas fa-concierge-bell';
            }
        }

        // View request details
        function viewRequestDetails(requestId) {
            const request = allRequests.find(req => req.id === requestId);
            
            if (request) {
                let dateFormatted = 'N/A';
                let timeFormatted = 'N/A';
                let updatedDateFormatted = 'N/A';
                
                try {
                    // Created date
                    const createdDate = request.createdAt?.toDate ? 
                        request.createdAt.toDate() : 
                        new Date(request.createdAt);
                    dateFormatted = createdDate.toLocaleDateString('en-KE', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    timeFormatted = createdDate.toLocaleTimeString('en-KE', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Updated date
                    if (request.updatedAt) {
                        const updatedDate = request.updatedAt?.toDate ? 
                            request.updatedAt.toDate() : 
                            new Date(request.updatedAt);
                        updatedDateFormatted = updatedDate.toLocaleDateString('en-KE', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }) + ' ' + updatedDate.toLocaleTimeString('en-KE', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {
                    dateFormatted = 'N/A';
                    timeFormatted = 'N/A';
                    updatedDateFormatted = 'N/A';
                }
                
                // Get status display
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                
                switch(request.status) {
                    case 'processing':
                        statusClass = 'status-processing';
                        statusText = 'In Progress';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'Completed';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = 'Cancelled';
                        break;
                }
                
                // Get urgency display
                let urgencyClass = 'urgency-normal';
                let urgencyText = 'Normal';
                
                switch(request.urgency) {
                    case 'high':
                        urgencyClass = 'urgency-high';
                        urgencyText = 'High';
                        break;
                    case 'urgent':
                        urgencyClass = 'urgency-urgent';
                        urgencyText = 'Urgent';
                        break;
                }
                
                const content = document.getElementById('requestDetailsContent');
                content.innerHTML = `
                    <div class="request-details-grid">
                        <div class="detail-group">
                            <label>Service Name</label>
                            <div class="detail-value">
                                <i class="${getServiceIcon(request.serviceName)}"></i> ${request.serviceName || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Service ID</label>
                            <div class="detail-value">${request.serviceId || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Cost</label>
                            <div class="detail-value">${request.cost || 'KES 0'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Status</label>
                            <div class="detail-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Urgency</label>
                            <div class="detail-value">
                                <span class="urgency-badge ${urgencyClass}">${urgencyText}</span>
                            </div>
                        </div>
                        
                        <div class="detail-group">
                            <label>User ID</label>
                            <div class="detail-value">${request.userId || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Date Submitted</label>
                            <div class="detail-value">${dateFormatted} at ${timeFormatted}</div>
                        </div>
                        
                        ${request.updatedAt ? `
                        <div class="detail-group">
                            <label>Last Updated</label>
                            <div class="detail-value">${updatedDateFormatted}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${request.details ? `
                    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--kenya-black);">
                            <i class="fas fa-file-alt"></i> Service Details
                        </h4>
                        <p style="line-height: 1.6; white-space: pre-wrap;">${request.details}</p>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button class="logout-btn" onclick="showUpdateStatusForm('${request.id}')" 
                                style="background-color: #0081C8;">
                            <i class="fas fa-edit"></i> Update Status
                        </button>
                        <button class="logout-btn" onclick="deleteRequest('${request.id}')" 
                                style="background-color: var(--kenya-red);">
                            <i class="fas fa-trash"></i> Delete Request
                        </button>
                    </div>
                `;
                
                // Show modal
                document.getElementById('requestDetailsModal').style.display = 'flex';
            }
        }

        // Show update status form
        function showUpdateStatusForm(requestId) {
            const request = allRequests.find(req => req.id === requestId);
            
            if (request) {
                currentRequestId = requestId;
                
                const content = document.getElementById('updateStatusContent');
                content.innerHTML = `
                    <div class="status-form">
                        <div class="form-group">
                            <label for="newStatus">Update Status</label>
                            <select id="newStatus" class="form-control">
                                <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="processing" ${request.status === 'processing' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="updateNotes">Notes (Optional)</label>
                            <textarea id="updateNotes" class="form-control" rows="3" placeholder="Add any notes about this update..."></textarea>
                        </div>
                        
                        <button class="save-btn" onclick="updateRequestStatus()">
                            <i class="fas fa-save"></i> Update Status
                        </button>
                    </div>
                `;
                
                // Show modal
                document.getElementById('updateStatusModal').style.display = 'flex';
            }
        }

        // Update request status in Firebase
        async function updateRequestStatus() {
            const newStatus = document.getElementById('newStatus').value;
            const notes = document.getElementById('updateNotes').value;
            
            if (!currentRequestId) return;
            
            showLoader();
            
            try {
                const updateData = {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add notes if provided
                if (notes.trim()) {
                    // Check if details field exists and add note
                    const request = allRequests.find(req => req.id === currentRequestId);
                    if (request && request.details) {
                        updateData.details = request.details + '\n\n--- Status Update ---\n' + 
                            new Date().toLocaleString() + ': ' + newStatus + 
                            (notes ? '\nNotes: ' + notes : '');
                    }
                }
                
                await db.collection('serviceRequests').doc(currentRequestId).update(updateData);
                
                showToast(`Request status updated to ${newStatus}`, 'success');
                
                // Close modal
                document.getElementById('updateStatusModal').style.display = 'none';
                document.getElementById('requestDetailsModal').style.display = 'none';
                
                // Clear current request ID
                currentRequestId = null;
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Error updating status: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // Delete request from Firebase
        async function deleteRequest(requestId) {
            if (confirm('Are you sure you want to delete this service request? This action cannot be undone.')) {
                showLoader();
                
                try {
                    await db.collection('serviceRequests').doc(requestId).delete();
                    showToast('Service request deleted successfully', 'success');
                    
                    // Close modals if open
                    document.getElementById('requestDetailsModal').style.display = 'none';
                    document.getElementById('updateStatusModal').style.display = 'none';
                } catch (error) {
                    console.error('Error deleting request:', error);
                    showToast('Error deleting request: ' + error.message, 'error');
                } finally {
                    hideLoader();
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form submission - For demo, accept any credentials
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                showLoader();
                
                try {
                    // Try Firebase authentication
                    await auth.signInWithEmailAndPassword(email, password);
                    showToast('Login successful!', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    
                    // For demo purposes, create a dummy user session
                    currentUser = {
                        email: email,
                        displayName: 'Admin User'
                    };
                    
                    showDashboard();
                    
                    // Try to load data even without proper auth
                    try {
                        setupRealtimeListeners();
                    } catch (firebaseError) {
                        showToast('Could not connect to Firebase database', 'error');
                    }
                } finally {
                    hideLoader();
                }
            });
            
            // Logout button
            logoutBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await auth.signOut();
                        showLogin();
                        showToast('Logged out successfully!', 'info');
                    } catch (error) {
                        console.error('Logout error:', error);
                        showLogin();
                        showToast('Logged out!', 'info');
                    }
                }
            });
            
            // Status tab clicks
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Filter requests
                    filterAndDisplayRequests();
                });
            });
            
            // Filter changes
            document.getElementById('filterService').addEventListener('change', filterAndDisplayRequests);
            document.getElementById('filterUrgency').addEventListener('change', filterAndDisplayRequests);
            document.getElementById('filterDate').addEventListener('change', filterAndDisplayRequests);
            
            // Search input
            document.getElementById('searchInput').addEventListener('input', filterAndDisplayRequests);
            
            // Close modal buttons
            document.getElementById('closeDetailsModal').addEventListener('click', () => {
                document.getElementById('requestDetailsModal').style.display = 'none';
            });
            
            document.getElementById('closeUpdateModal').addEventListener('click', () => {
                document.getElementById('updateStatusModal').style.display = 'none';
                currentRequestId = null;
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                const detailsModal = document.getElementById('requestDetailsModal');
                const updateModal = document.getElementById('updateStatusModal');
                
                if (e.target === detailsModal) {
                    detailsModal.style.display = 'none';
                }
                
                if (e.target === updateModal) {
                    updateModal.style.display = 'none';
                    currentRequestId = null;
                }
            });
        }

        // Show loader
        function showLoader() {
            document.getElementById('loader').classList.add('active');
        }

        // Hide loader
        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Helper functions
        function getInitials(name) {
            if (!name || name === 'N/A') return 'A';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // Make functions available globally
        window.viewRequestDetails = viewRequestDetails;
        window.showUpdateStatusForm = showUpdateStatusForm;
        window.updateRequestStatus = updateRequestStatus;
        window.deleteRequest = deleteRequest;
    </script>
</body>
</html>